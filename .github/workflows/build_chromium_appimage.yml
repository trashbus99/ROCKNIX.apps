name: Build Chromium ARM64 AppImage

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 emulation
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support

      - name: Add ARM64 Architecture and Sources
        run: |
          sudo dpkg --add-architecture arm64
          sudo tee /etc/apt/sources.list.d/arm64.list <<EOF
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-security main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-backports main restricted universe multiverse
          EOF
          sudo apt-get update

      - name: Install Cross-Compilation Dependencies
        run: |
          sudo apt-get install -y \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          libc6-dev-arm64-cross libstdc++-12-dev-arm64-cross \
          ninja-build cmake python3 python3-pip curl git

      - name: Clone Chromium Source
        run: |
          git clone https://chromium.googlesource.com/chromium/src chromium
          cd chromium
          git checkout main
          ./build/install-build-deps.sh --arm

      - name: Configure and Build Chromium for ARM64
        run: |
          cd chromium
          gn gen out/arm64 --args='target_cpu="arm64" is_debug=false'
          autoninja -C out/arm64 chrome

      - name: Package Chromium as an AppImage
        run: |
          mkdir -p AppDir/usr/bin
          cp chromium/out/arm64/chrome AppDir/usr/bin/
          wget -qO appimagetool https://github.com/AppImage/AppImageKit/releases/latest/download/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          ./appimagetool AppDir Chromium_ARM64.AppImage

      - name: Upload Chromium ARM64 AppImage
        uses: actions/upload-artifact@v4
        with:
          name: Chromium-ARM64
          path: Chromium_ARM64.AppImage
          retention-days: 7
